namespace HKMirror.Hooks.OnHooks;

/// <summary>
///     Contains different types of On Hooks for PlatformVibrationHelper class.<br />
///     Contains hooks that aren't generated by monomod, and before and after orig hooks for easier hooking.
/// </summary>
public static class OnPlatformVibrationHelper
{
    internal static class HookHandler
    {
        private static readonly List<string> HookedList = new();

        internal static void HookDestroy()
        {
            if (!HookedList.Contains("Destroy"))
            {
                HookedList.Add("Destroy");
                On.PlatformVibrationHelper.Destroy += Destroy;
            }
        }

        internal static event Delegates.Destroy_BeforeArgs _beforeDestroy;
        internal static event Delegates.Destroy_AfterArgs _afterDestroy;

        private static void Destroy(On.PlatformVibrationHelper.orig_Destroy orig, PlatformVibrationHelper self)
        {
            Delegates.Params_Destroy @params = new()
            {
                self = self
            };
            if (_beforeDestroy != null)
                foreach (Delegates.Destroy_BeforeArgs toInvoke in _beforeDestroy.GetInvocationList())
                    try
                    {
                        _beforeDestroy?.Invoke(@params);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }

            self = @params.self;
            orig(self);
            if (_afterDestroy != null)
                foreach (Delegates.Destroy_AfterArgs toInvoke in _afterDestroy.GetInvocationList())
                    try
                    {
                        _afterDestroy.Invoke(@params);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }
        }

        internal static void HookUpdateVibration()
        {
            if (!HookedList.Contains("UpdateVibration"))
            {
                HookedList.Add("UpdateVibration");
                On.PlatformVibrationHelper.UpdateVibration += UpdateVibration;
            }
        }

        internal static event Delegates.UpdateVibration_BeforeArgs _beforeUpdateVibration;
        internal static event Delegates.UpdateVibration_AfterArgs _afterUpdateVibration;

        private static void UpdateVibration(On.PlatformVibrationHelper.orig_UpdateVibration orig,
            PlatformVibrationHelper self)
        {
            Delegates.Params_UpdateVibration @params = new()
            {
                self = self
            };
            if (_beforeUpdateVibration != null)
                foreach (Delegates.UpdateVibration_BeforeArgs toInvoke in _beforeUpdateVibration.GetInvocationList())
                    try
                    {
                        _beforeUpdateVibration?.Invoke(@params);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }

            self = @params.self;
            orig(self);
            if (_afterUpdateVibration != null)
                foreach (Delegates.UpdateVibration_AfterArgs toInvoke in _afterUpdateVibration.GetInvocationList())
                    try
                    {
                        _afterUpdateVibration.Invoke(@params);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }
        }

        internal static void HookGetMixer()
        {
            if (!HookedList.Contains("GetMixer"))
            {
                HookedList.Add("GetMixer");
                On.PlatformVibrationHelper.GetMixer += GetMixer;
            }
        }

        internal static event Delegates.GetMixer_BeforeArgs _beforeGetMixer;
        internal static event Delegates.GetMixer_AfterArgs _afterGetMixer;

        private static VibrationMixer GetMixer(On.PlatformVibrationHelper.orig_GetMixer orig,
            PlatformVibrationHelper self)
        {
            Delegates.Params_GetMixer @params = new()
            {
                self = self
            };
            if (_beforeGetMixer != null)
                foreach (Delegates.GetMixer_BeforeArgs toInvoke in _beforeGetMixer.GetInvocationList())
                    try
                    {
                        _beforeGetMixer?.Invoke(@params);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }

            self = @params.self;
            var retVal = orig(self);
            if (_afterGetMixer != null)
                foreach (Delegates.GetMixer_AfterArgs toInvoke in _afterGetMixer.GetInvocationList())
                    try
                    {
                        retVal = _afterGetMixer.Invoke(@params, retVal);
                    }
                    catch (Exception e)
                    {
                        HKMirrorMod.DoLogError(e);
                    }

            return retVal;
        }
    }

    /// <summary>
    ///     Contains necessary information to create Hooks. Does not contain any hooks
    /// </summary>
    public static class Delegates
    {
        public delegate void Destroy_AfterArgs(Params_Destroy args);

        public delegate void Destroy_BeforeArgs(Params_Destroy args);

        public delegate void Destroy_WithArgs(Action<PlatformVibrationHelper> orig, PlatformVibrationHelper self);

        public delegate VibrationMixer GetMixer_AfterArgs(Params_GetMixer args, VibrationMixer ret);

        public delegate void GetMixer_BeforeArgs(Params_GetMixer args);

        public delegate VibrationMixer GetMixer_WithArgs(Func<PlatformVibrationHelper, VibrationMixer> orig,
            PlatformVibrationHelper self);

        public delegate void UpdateVibration_AfterArgs(Params_UpdateVibration args);

        public delegate void UpdateVibration_BeforeArgs(Params_UpdateVibration args);

        public delegate void UpdateVibration_WithArgs(Action<PlatformVibrationHelper> orig,
            PlatformVibrationHelper self);

        public sealed class Params_Destroy
        {
            public PlatformVibrationHelper self;
        }

        public sealed class Params_UpdateVibration
        {
            public PlatformVibrationHelper self;
        }

        public sealed class Params_GetMixer
        {
            public PlatformVibrationHelper self;
        }
    }

    /// <summary>
    ///     Contains Hooks to that run code before orig(self) is called
    /// </summary>
    public static class BeforeOrig
    {
        public static event Delegates.Destroy_BeforeArgs Destroy
        {
            add
            {
                HookHandler._beforeDestroy += value;
                HookHandler.HookDestroy();
            }
            remove => HookHandler._beforeDestroy -= value;
        }

        public static event Delegates.UpdateVibration_BeforeArgs UpdateVibration
        {
            add
            {
                HookHandler._beforeUpdateVibration += value;
                HookHandler.HookUpdateVibration();
            }
            remove => HookHandler._beforeUpdateVibration -= value;
        }

        public static event Delegates.GetMixer_BeforeArgs GetMixer
        {
            add
            {
                HookHandler._beforeGetMixer += value;
                HookHandler.HookGetMixer();
            }
            remove => HookHandler._beforeGetMixer -= value;
        }
    }

    /// <summary>
    ///     Contains Hooks to that run code after orig(self) is called
    /// </summary>
    public static class AfterOrig
    {
        public static event Delegates.Destroy_AfterArgs Destroy
        {
            add
            {
                HookHandler._afterDestroy += value;
                HookHandler.HookDestroy();
            }
            remove => HookHandler._afterDestroy -= value;
        }

        public static event Delegates.UpdateVibration_AfterArgs UpdateVibration
        {
            add
            {
                HookHandler._afterUpdateVibration += value;
                HookHandler.HookUpdateVibration();
            }
            remove => HookHandler._afterUpdateVibration -= value;
        }

        public static event Delegates.GetMixer_AfterArgs GetMixer
        {
            add
            {
                HookHandler._afterGetMixer += value;
                HookHandler.HookGetMixer();
            }
            remove => HookHandler._afterGetMixer -= value;
        }
    }

    /// <summary>
    ///     Contains all On Hooks, even those that aren't in the On namespace such as API generated functions and property
    ///     getters/setters
    /// </summary>
    public static class WithOrig
    {
        public static event On.PlatformVibrationHelper.hook_Destroy Destroy
        {
            add => On.PlatformVibrationHelper.Destroy += value;
            remove => On.PlatformVibrationHelper.Destroy -= value;
        }

        public static event On.PlatformVibrationHelper.hook_UpdateVibration UpdateVibration
        {
            add => On.PlatformVibrationHelper.UpdateVibration += value;
            remove => On.PlatformVibrationHelper.UpdateVibration -= value;
        }

        public static event On.PlatformVibrationHelper.hook_GetMixer GetMixer
        {
            add => On.PlatformVibrationHelper.GetMixer += value;
            remove => On.PlatformVibrationHelper.GetMixer -= value;
        }
    }
}